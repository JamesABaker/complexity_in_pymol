#!/usr/bin/python

import sys
from Bio.PDB import PDBIO
from Bio.PDB.PDBParser import PDBParser
from Bio import SeqIO
import urllib2

if len(sys.argv) != 2:
    print("------------------------------------------------------")
    print("Usage : ./complexity.py <YOUR PDB>")
    print("------------------------------------------------------")
    sys.exit()
else:

    #Download the file
    url=("https://files.rcsb.org/download/%s" % sys.argv[1])
    file_name = url.split('/')[-1]
    u = urllib2.urlopen(url)
    f = open(file_name, 'wb')
    meta = u.info()
    file_size = int(meta.getheaders("Content-Length")[0])
    print "Downloading: %s Bytes: %s" % (file_name, file_size)
    file_size_dl = 0
    block_sz = 8192
    while True:
        buffer = u.read(block_sz)
        if not buffer:
            break

        file_size_dl += len(buffer)
        f.write(buffer)
        status = r"%10d  [%3.2f%%]" % (file_size_dl, file_size_dl * 100. / file_size)
        status = status + chr(8)*(len(status)+1)
        print status,

    f.close()




    PDB_input = sys.argv[1]
    print('Opening %s...' % sys.argv[1])
    parser = PDBParser()
    structure = parser.get_structure('self', PDB_input)
    model = structure[0]
    chain = model[' ']
    residue = chain[(' ', 1, ' ')]
    first_residue = chain.child_list[0]
    last_residue = chain.child_list[-1]

    #Cleans up any CHARMM files to standard PDB
    for residue in chain:
        if residue.resname == 'HSD':
            residue.resname = 'HIS'
        elif residue.resname == 'HSE':
            residue.resname = 'HIS'
        elif residue.resname == 'HSP':
            residue.resname = 'HIS'
        elif residue.resname == 'ILE':
            residue['CD'].fullname = ' CD1'
            residue['HD1'].fullname = '1HD1'
            residue['HD2'].fullname = '2HD1'
            residue['HD3'].fullname = '3HD1'
        elif residue.resname == 'SER':
            residue['HG1'].fullname = '1HG '

    first_residue['HT1'].fullname = '1HT '
    first_residue['HT2'].fullname = '2HT '
    first_residue['HT3'].fullname = '3HT '

    last_residue['OT1'].fullname = ' OXT'
    last_residue['OT2'].fullname = ' O  '

    w = PDBIO()
    w.set_structure(structure)
    w.save('%scorrected_from_CHARMM_to_PDB.pdb' % sys.argv[1])
